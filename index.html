<!DOCTYPE html>
<meta charset="utf-8">

<style>

body {
  margin: 0;
  padding: 0;
}

#boroughs {
  fill: #0f1932;
}
</style>

<script src="d3.min.js" charset="utf-8"></script>
<script src="jquery-1.11.2.min.js" charset="utf-8"></script>
<script type="text/javascript" src="http://cdn.tonejs.org/latest/Tone.min.js"></script>


<body>

  <script>

 
  var sampler = new Tone.Sampler({
    "samples" : {
      "intro" : "./samples/spotify/Spotify Hack_Intro.mp3",
      "arp1" : "./samples/spotify/Spotify Hack_Arp_1.mp3",
      "arp2" : "./samples/spotify/Spotify Hack_Arp_2.mp3",
      "bass1" : "./samples/spotify/Spotify Hack_Bass_1.mp3",
      "bass2" : "./samples/spotify/Spotify Hack_Bass_2.mp3",
      "bass3" : "./samples/spotify/Spotify Hack_Bass_3.mp3",
      "boop1" : "./samples/spotify/Spotify Hack_Boop_1.mp3",
      "field1" : "./samples/spotify/Spotify Hack_Field_1.mp3",
      "field2" : "./samples/spotify/Spotify Hack_Field_2.mp3",
      "hat1" : "./samples/spotify/Spotify Hack_Hat_1.mp3",
      "hat2" : "./samples/spotify/Spotify Hack_Hat_2.mp3",
      "hat3" : "./samples/spotify/Spotify Hack_Hat_3.mp3",
      "kick1" : "./samples/spotify/Spotify Hack_Kick_1.mp3",
      "kick2" : "./samples/spotify/Spotify Hack_Kick_2.mp3",
      "kickalt" : "./samples/spotify/Spotify Hack_Kick_Alt.mp3",
      "switch1" : "./samples/spotify/Spotify Hack_Switch.mp3",
      "switch2" : "./samples/spotify/Spotify Hack_Switch_2.mp3",
      "synth1" : "./samples/spotify/Spotify Hack_Synth_1.mp3",
      "synth2" : "./samples/spotify/Spotify Hack_Synth_2.mp3",
      "synth3" : "./samples/spotify/Spotify Hack_Synth_3.mp3",
      "synth4" : "./samples/spotify/Spotify Hack_Synth_4.mp3",
    }
  }).toMaster();

  
  Tone.Buffer.onload = function(){
    console.log("loaded");
    sampler.triggerAttack("samples.intro");
    

  };

  Tone.Buffer.onprogress = function(progress){
    console.log("progress", progress);
  };


  var width = 960,
     height = 500;

  var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

  svg.append("rect")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("fill", "#20007a");

  d3.json("nyc.json", function(error, nyb) {

    //console.log(nyb)

    var projection = d3.geo.mercator()
                    //.center([-73.94, 40.70])
                    //.scale(50000)
                    .center([-73.97, 40.72])
                    .scale(250000)
                    .translate([(width) / 2, (height)/2]);

    var path = d3.geo.path()
            .projection(projection);

    var g = svg.append("g");

    g.append("g")
        .attr("id", "boroughs")
        .selectAll(".state")
        .data(nyb.features)
        .enter().append("path")
        .attr("class", function(d){ return d.properties.name; })
        .attr("d", path);

      // var text = svg.append("svg:text")
      //     .attr("x", 20)
      //     .attr("y", 20);

      var start = Date.now(),
          frames = 0;


      d3.timer(function() 
      {

        // Update the FPS meter.
        var now = Date.now(), duration = now - start;
        //text.text(~~(++frames * 1000 / duration));
        if (duration >= 1000) {
          frames = 0;
          start = now;
          $.ajax({
            type: "GET",
            url: "http://localhost:3012/trip/2014-07-01 00:00:04",
            dataType: "json"
          }).done (function (data) {

            var station_array = data.stations;
            var circle = svg.selectAll("circle")
            .data([JSON.parse(data)])//need to put it in an array?
          .enter().append("svg:circle")
            .attr("r", 1)
            .attr("fill","#eb1e32")
            .attr("opacity","1")

            
            var start_blip = Date.now();

            Tone.Buffer.onload = function(){
              console.log("loaded");
              sampler.triggerAttack("samples.bass1");
              

            };

            Tone.Buffer.onprogress = function(progress){
              console.log("progress", progress);
            };

            
        

            d3.timer(function() 
            {



              var blip_now = Date.now(), blip_duration = blip_now - start_blip;
              circle
              .attr("cx", function(d) {point = projection([d.longitude,d.latitude]); return point[0] })
              .attr("cy", function(d) {point = projection([d.longitude,d.latitude]); return point[1] })
              .attr("r",function(d)
              {
                return blip_duration/100;
              });
              if (blip_duration > 1000) {

              
                circle.remove()
                return true;
              }



            });


          });
        }
    
    });

  });

  </script>
</body>
</html>